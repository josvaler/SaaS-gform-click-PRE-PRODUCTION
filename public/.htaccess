# Activar mod_rewrite
RewriteEngine On
RewriteBase /

# --- Admin route (MUST come first, before any other rules) ---
# Handle both /admin and /admin/ - rewrite to admin.php even if admin/ directory exists
# This prevents Apache from treating /admin/ as a directory request
RewriteCond %{REQUEST_URI} ^/admin/?$ [NC]
RewriteRule ^admin/?$ admin.php [L,QSA]

# --- Regenerate QR route (must come before general .php rule) ---
RewriteRule ^regenerate-qr$ regenerate-qr.php [L,QSA]

# --- Link details route ---
RewriteRule ^link/([a-zA-Z0-9_-]+)$ link-details.php?code=$1 [L,QSA]

# --- Stripe webhook route - allow direct .php access ---
# Allow direct access to webhook.php (Stripe uses .php extension)
RewriteRule ^stripe/webhook\.php$ stripe/webhook.php [L,QSA]
# Also allow clean URL for backward compatibility
RewriteRule ^stripe/webhook$ stripe/webhook.php [L,QSA]

# --- Chrome Extension API routes (must come before general .php rule) ---
# Allow clean URLs for Chrome API endpoints
RewriteRule ^api/chrome/auth/verify$ api/chrome/auth/verify.php [L,QSA]
RewriteRule ^api/chrome/create$ api/chrome/create.php [L,QSA]

# Pass Authorization header to PHP (for mod_rewrite compatibility)
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

# --- Quitar .php de las URLs ---
# Si el archivo existe con .php, servirlo sin mostrar la extensión
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*)$ $1.php [L]

# --- Short code redirects ---
# If not a file, directory, or known route, try redirect handler
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/(login|dashboard|profile|create-link|links|link|pricing|billing|logout|admin|stripe|qr|assets|regenerate-qr|set-language|terms|privacy|explore|api|send-email) [NC]
RewriteRule ^([a-zA-Z0-9_-]+)$ redirect.php [L,QSA]

# --- Evitar acceso directo a PHP internos ---
RewriteRule ^(.*/)?\.ht.* - [F]

# --- Seguridad básica ---
<FilesMatch "\.(env|ini|log|cache|bak|sql)$">
    Require all denied
</FilesMatch>

# Evitar listar directorios
Options -Indexes

# Forzar UTF-8
AddDefaultCharset UTF-8

# Bloquear acceso al .htaccess
<Files ".htaccess">
    Require all granted
</Files>

# --- Forzar HTTPS si lo necesitas ---
# Descomenta si deseas forzarlo
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
